{"version":3,"file":"memory_record.js","names":["_lodash","_interopRequireDefault","require","obj","__esModule","default","MemoryRecord","define","Error","name","memory_record_reset","records","_values","undefined","_keys_hash","_codes_hash","_keys","_codes","_names","_records","memory_record_create_index_by","columns","values","reduce","a","e","forEach","column","v","JSON","stringify","Object","keys","join","lookup","key","codes_hash","keys_hash","fetch","element","codes","fetch_if","lookup_or_first","_","map","__source_records","i","assign","index","code","freeze","names","count","length","constructor","attributes","defineProperty","value","writable","enumerable","configurable","forIn","k","toString","exports","process","argv","__filename","Foo","console","log","record"],"sources":["../src/memory_record.js"],"sourcesContent":["// Example.\n//\n//   import MemoryRecord from \"./memory_record\"\n//\n//   class Foo extends MemoryRecord {\n//     static get define() {\n//       return [\n//         { key: \"black\", name: '☗', },\n//         { key: \"white\", name: '☖', },\n//       ]\n//     }\n//\n//     get flip() {\n//       return Foo.values[(this.code + 1) % Foo.values.length]\n//     }\n//   }\n//\n//   Foo.lookup(\"black\").key           // => \"black\"\n//   Foo.lookup(1).key                 // => \"white\"\n//   Foo.values[0] === Foo.values[0]   // => true\n//\n\nimport _ from \"lodash\"\n\nexport default class MemoryRecord {\n  static get define() {\n    throw new Error(`${this.name}.define() is not implemented`)\n  }\n\n  static memory_record_reset(records) {\n    this._values     = undefined\n    this._keys_hash  = undefined\n    this._codes_hash = undefined\n    this._keys       = undefined\n    this._codes      = undefined\n    this._names      = undefined\n\n    this._records = records\n\n    return this\n  }\n\n  static memory_record_create_index_by(columns) {\n    return this.values.reduce((a, e) => {\n      columns.forEach(column => {\n        const v = e[column]\n        if (v != null) {\n          if (v in a) {\n            throw new Error([\n              `${this.name}#${column} ${JSON.stringify(v)} is duplicate`,\n              `Existing: ${JSON.stringify(Object.keys(a))}`,\n              `Conflict: ${JSON.stringify(e)}`,\n            ].join(\"\\n\"))\n          }\n          a[v] = e\n        }\n      })\n      return a\n    }, {})\n  }\n\n  static lookup(key) {\n    if (key instanceof this) {\n      return key\n    }\n    if (typeof key === \"number\") {\n      return this.codes_hash[key]\n    } else {\n      return this.keys_hash[key]\n    }\n  }\n\n  static fetch(key) {\n    const element = this.lookup(key)\n    if (!element) {\n      throw new Error([\n        `${this.name}.fetch(${JSON.stringify(key)}) does not match anything`,\n        `keys: ${JSON.stringify(this.keys)}`,\n        `codes: ${JSON.stringify(this.codes)}`,\n      ].join(\"\\n\"))\n    }\n    return element\n  }\n\n  static fetch_if(key) {\n    if (key != null) {\n      return this.fetch(key)\n    }\n  }\n\n  static lookup_or_first(key) {\n    return this.lookup(key) || this.values[0]\n  }\n\n  static get values() {\n    if (this._values !== undefined) {\n      return this._values\n    }\n    this._values = _.map(this.__source_records, (e, i) => {\n      e = Object.assign({}, e, {index: i})\n      if (!(\"code\" in e)) {\n        e = Object.assign({}, e, {code: i})\n      }\n      if (!(\"key\" in e)) {\n        e = Object.assign({}, e, {key: `_key${i}`})\n      }\n      return Object.freeze(new this(e))\n    })\n    return this._values\n  }\n\n  static get keys_hash() {\n    if (this._keys_hash != null) {\n      return this._keys_hash\n    }\n    this._keys_hash = this.memory_record_create_index_by([\"key\"])\n    return this._keys_hash\n  }\n\n  static get codes_hash() {\n    if (this._codes_hash != null) {\n      return this._codes_hash\n    }\n    this._codes_hash = this.memory_record_create_index_by([\"code\"])\n    return this._codes_hash\n  }\n\n  static get keys() {\n    if (this._keys != null) {\n      return this._keys\n    }\n    this._keys = Object.keys(this.keys_hash)\n    return this._keys\n  }\n\n  static get codes() {\n    if (this._codes != null) {\n      return this._codes\n    }\n    this._codes = this.values.map(e => e.code)\n    return this._codes\n  }\n\n  static get names() {\n    if (this._names != null) {\n      return this._names\n    }\n    this._names = this.values.map(e => e.name)\n    return this._names\n  }\n\n  static get count() {\n    return this.values.length\n  }\n\n  // private\n  static get __source_records() {\n    if (this._records != null) {\n      return this._records\n    }\n    this._records = this.define\n    return this._records\n  }\n\n  constructor(attributes) {\n    Object.defineProperty(this, \"attributes\", {value: attributes, writable: false, enumerable: false, configurable: false})\n\n    _.forIn(attributes, (e, k) => {\n      Object.defineProperty(this, k, {value: e, writable: false, enumerable: true, configurable: false})\n    })\n\n    // If name is not defined, it returns string converted from key\n    // In the case of this.hasOwnProperty (\"name\") see parents. Parents also look at in.\n    if (!(\"name\" in this)) {\n      Object.defineProperty(this, \"name\", {value: attributes.name || attributes.key.toString(), writable: false, enumerable: true, configurable: false})\n    }\n  }\n}\n\nif (typeof process !== \"undefined\" && process.argv[1] === __filename) {\n  class Foo extends MemoryRecord {\n    static get define() {\n      return [\n        { key: \"black\", name: '☗', },\n        { key: \"white\", name: '☖', },\n        { code: 7, },\n      ]\n    }\n  }\n\n  console.log(Foo.keys)\n  console.log(Foo.codes)\n\n  const record = Foo.values[0]\n  console.log(record.key)\n  console.log(record.code)\n  console.log(record.name)\n\n  console.log(Foo.values)\n  console.log(Foo.lookup(\"black\").name)\n  console.log(Foo.lookup(\"black\").code)\n\n  console.log(Foo.lookup(\"_key2\").name)\n\n  let v = Foo.lookup(\"black\")\n  console.log(v instanceof Foo)\n\n  console.log(Foo.lookup(0))\n  console.log(Foo.lookup(1))\n  console.log(Foo.lookup(2))\n\n  console.log(Foo.values[0] === Foo.values[0])\n\n  console.log(Foo.values.map(e => e.key))\n  console.log(Object.keys(Foo.keys_hash))\n  console.log(Foo.fetch('unknown'))\n}\n"],"mappings":"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"}